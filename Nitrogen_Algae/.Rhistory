),
## consider using bbmle::dnorm_n ?
observation = list(
nh4 ~ dnorm2(mean = pred_nh4),
chl ~ dnorm2(mean = pred_chl)
),
initial = list(pred_nh4 ~ pred_nh40 , pred_chl ~ pred_chl0),
par=c("alpha", "beta", "omega", "death1","death2", "pred_nh40", "pred_chl0", "gamma")
)
## maybe figure out initial values
start <- c(alpha = 0.03,
beta = 15,
omega=2.3,
death1=0.006,
death2=0.001,
pred_nh40 = 15 ,
pred_chl0 = 40,
gamma=0.01
)
chl_nh4_mod <- new("model.ode",
name = "algal_nit",
model = list(
pred_nh4 ~ -pred_chl*pred_nh4*alpha*omega/(omega+pred_nh4) + gamma *(death2*(pred_chl^2))-cammonium*pred_nh4 ,
pred_chl ~ beta * pred_chl*pred_nh4*alpha*omega/(omega+pred_nh4) - death2*(pred_chl^2)
),
## consider using bbmle::dnorm_n ?
observation = list(
nh4 ~ dnorm2(mean = pred_nh4),
chl ~ dnorm2(mean = pred_chl)
),
initial = list(pred_nh4 ~ pred_nh40 , pred_chl ~ pred_chl0),
par=c("alpha", "beta", "omega", "death2", "pred_nh40", "pred_chl0", "gamma")
)
## maybe figure out initial values
start <- c(alpha = 0.03,
beta = 15,
omega=2.3,
#death1=0,
death2=0.001,
pred_nh40 = 15 ,
pred_chl0 = 40,
gamma=0.01
)
chl_fit_27_dd <- fitode(
chl_nh4_mod,
data = dat_nit_27,
start=start,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
)
v = vcov(chl_fit_27_dd)
cc1 = (cov2cor(v))
cc1
start2 <- coef(chl_fit_27_dd)
start2[["pred_nh40"]] <- 6
start2[["pred_chl0"]] <- 50
##
chl_fit_9_dd <- fitode(
chl_nh4_mod,
data = dat_nit_9,
start=start2,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
v= vcov(chl_fit_9_dd,"fitted")
cm = cov2cor(v)
cm
start3 <- c(alpha = 0.003,
beta = 15,
omega=400,
#death1=0.001,
death2=0.00003,
pred_nh40 = 3.5 ,
pred_chl0 = 40,
gamma=1,
sd1 = .2,
sd2 = 30)
chl_fit_3_dd <- fitode(
chl_nh4_mod,
data = dat_nit_3,
start=start3,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
v3 <- vcov(chl_fit_3_dd)
c3 <- cov2cor(v3)
c3
start4 <- coef(chl_fit_27_dd)
start4[["pred_nh40"]] <- 22
start4[["pred_chl0"]] <- 40
chl_fit_54 <- fitode(
chl_nh4_mod,
data = dat_nit_54,
start=start4,
tcol = "date1" ,
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
v54 = vcov(chl_fit_54)
cc54 = cov2cor(v54)
cc54
start5 <- coef(chl_fit_54)
start5[["pred_nh40"]] <- 40
start5[["pred_chl0"]] <- 40
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start6 <- coef(chl_fit_27_dd)
start6[["pred_nh40"]] <- 2.5
start6[["pred_chl0"]] <- 40
#### this isn't great-- will also fit with 54 starting starting values but that has worse fit
chl_fit_0.5 <- fitode(
chl_nh4_mod,
data = dat_nit_0.5,
start=start6,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
)
plot(chl_fit_0.5, level = 0.95)
chl_fit_0.5a <- fitode(
chl_nh4_mod,
data = dat_nit_0.5[dat_nit_0.5$nh4 < 4,],
start=start6,
tcol = "date1" ,
solver.opts=list(method="rk4", hini=0.1)
)
plot(chl_fit_0.5a, level = 0.95)
treat0.5 <- data.frame(confint(chl_fit_0.5a))
treat3 <- data.frame(confint(chl_fit_3_dd))
treat9 <- data.frame(confint(chl_fit_9_dd))
treat27 <- data.frame(confint(chl_fit_27_dd))
treat54 <- data.frame(confint(chl_fit_54))
treat108 <- data.frame(confint(chl_fit_108))
all_param <- data.frame(
model =  rep(c("chl_fit_0.5", "chl_fit_3","chl_fit_9","chl_fit_27","chl_fit_54","chl_fit_108"), each=8),
parameter = rep(names(start),6),
estimate = c(treat0.5$estimate,treat3$estimate,treat9$estimate,treat27$estimate,treat54$estimate,treat108$estimate),
lowcon = c(treat0.5$X2.5..,treat3$X2.5..,treat9$X2.5..,treat27$X2.5..,treat54$X2.5..,treat108$X2.5..),
uppcon =  c(treat0.5$X97.5..,treat3$X97.5..,treat9$X97.5..,treat27$X97.5..,treat54$X97.5..,treat108$X97.5..)
)
start
all_param <- data.frame(
model =  rep(c("chl_fit_0.5", "chl_fit_3","chl_fit_9","chl_fit_27","chl_fit_54","chl_fit_108"), each=7),
parameter = rep(names(start),6),
estimate = c(treat0.5$estimate,treat3$estimate,treat9$estimate,treat27$estimate,treat54$estimate,treat108$estimate),
lowcon = c(treat0.5$X2.5..,treat3$X2.5..,treat9$X2.5..,treat27$X2.5..,treat54$X2.5..,treat108$X2.5..),
uppcon =  c(treat0.5$X97.5..,treat3$X97.5..,treat9$X97.5..,treat27$X97.5..,treat54$X97.5..,treat108$X97.5..)
)
all_param$model <- factor(all_param$model, levels = c("chl_fit_0.5", "chl_fit_3","chl_fit_9","chl_fit_27","chl_fit_54","chl_fit_108"))
filter_param <- all_param %>%
filter(!(parameter %in% c("pred_nh40", "pred_chl0", "sd1", "sd2")))
ggplot(filter_param, aes(model,estimate)) +
geom_point() +
#geom_errorbar(aes(model, ymin=lowcon, ymax=uppcon)) +
#scale_y_log10() +
facet_wrap(~parameter, scale="free_y")
## remove really high estimates
par2 <- filter_param %>% filter(estimate < 1000)
ggplot(par2, aes(model,estimate)) +
geom_point() +
#geom_errorbar(aes(model, ymin=lowcon, ymax=uppcon)) +
#scale_y_log10() +
facet_wrap(~parameter, scale="free_y")
ggplot(par2, aes(model,estimate)) +
geom_point() +
geom_errorbar(aes(model, ymin=lowcon, ymax=uppcon)) +
scale_y_log10() +
facet_wrap(~parameter, scale="free_y")
plot(chl_fit_27_dd, level=0.95)
plot(chl_fit_9_dd, level=0.95)
plot(chl_fit_3_dd, level=0.95)
plot(chl_fit_54, level=0.95)
plot(chl_fit_108,level = 0.95)
plot(chl_fit_0.5, level = 0.95)
plot(chl_fit_0.5a, level = 0.95)
plot(chl_fit_27_dd, level=0.95)
start <- c(alpha = 0.03,
beta = 15,
omega=2.3,
#death1=0,
death2=0.0001,
pred_nh40 = 15 ,
pred_chl0 = 40,
gamma=0.05
)
chl_fit_27_dd <- fitode(
chl_nh4_mod,
data = dat_nit_27,
start=start,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
)
plot(chl_fit_27_dd, level=0.95)
coef(chl_fit_27_dd)
v = vcov(chl_fit_27_dd)
cc1 = (cov2cor(v))
cc1
start <- c(alpha = 0.03,
beta = 15,
omega=2,
#death1=0,
death2=0.0001,
pred_nh40 = 15 ,
pred_chl0 = 40,
gamma=0.05
)
chl_fit_27_dd <- fitode(
chl_nh4_mod,
data = dat_nit_27,
start=start,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
)
plot(chl_fit_27_dd, level=0.95)
v = vcov(chl_fit_27_dd)
cc1 = (cov2cor(v))
cc1
start <- c(alpha = 0.03,
beta = 15,
omega=2.3,
#death1=0,
death2=0.0005,
pred_nh40 = 15 ,
pred_chl0 = 40,
gamma=0.03
)
chl_fit_27_dd <- fitode(
chl_nh4_mod,
data = dat_nit_27,
start=start,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
)
plot(chl_fit_27_dd, level=0.95)
v = vcov(chl_fit_27_dd)
cc1 = (cov2cor(v))
cc1
start2 <- coef(chl_fit_27_dd)
start2[["pred_nh40"]] <- 6
start2[["pred_chl0"]] <- 50
##
chl_fit_9_dd <- fitode(
chl_nh4_mod,
data = dat_nit_9,
start=start2,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
plot(chl_fit_9_dd, level=0.95)
v= vcov(chl_fit_9_dd,"fitted")
cm = cov2cor(v)
cm
v= vcov(chl_fit_9_dd) #,"fitted")
cm = cov2cor(v)
cm
corrplot(cc1)
coef(chl_fit_27_dd)
plot(chl_fit_9_dd, level=0.95)
plot(chl_fit_27_dd, level=0.95)
start3 <- c(alpha = 0.003,
beta = 15,
omega=400,
#death1=0.001,
death2=0.00003,
pred_nh40 = 3.5 ,
pred_chl0 = 40,
gamma=1,
sd1 = .2,
sd2 = 30)
chl_fit_3_dd <- fitode(
chl_nh4_mod,
data = dat_nit_3,
start=start3,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
plot(chl_fit_3_dd, level=0.95)
v3 <- vcov(chl_fit_3_dd)
c3 <- cov2cor(v3)
c3
start4 <- coef(chl_fit_27_dd)
start4[["pred_nh40"]] <- 22
start4[["pred_chl0"]] <- 40
chl_fit_54 <- fitode(
chl_nh4_mod,
data = dat_nit_54,
start=start4,
tcol = "date1" ,
solver.opts=list(method="rk4", hini=0.1)
#method="Nelder-Mead"
)
plot(chl_fit_54, level=0.95)
start5 <- coef(chl_fit_54)
start5[["pred_nh40"]] <- 40
start5[["pred_chl0"]] <- 40
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
coef(chl_fit_54)
coef(chl_fit_108)
start5 <- c(alpha = .002,
beta = 14,
omega = 46,
death2 = 1.086707e-06,
pred_nh40 = 40,
pred_chl0 = 52,
gamma = 23)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .002,
beta = 14,
omega = 46,
death2 = .000005,
pred_nh40 = 40,
pred_chl0 = 40,
gamma = 23)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .002,
beta = 14,
omega = 46,
death2 = .00001,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 23)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .02,
beta = 14,
omega = 46,
death2 = .00001,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 23)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .02,
beta = 14,
omega = 46,
death2 = .00005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 23)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .001,
beta = 14,
omega = 46,
death2 = .000001,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
v=vcov(chl_fit_108)
cov2cor(v)
start5 <- c(alpha = .001,
beta = 10,
omega = 46,
death2 = .000001,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .001,
beta = 10,
omega = 15,
death2 = .000001,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .001,
beta = 10,
omega = 15,
death2 = .000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .001,
beta = 10,
omega = 50,
death2 = .0000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
v=vcov(chl_fit_108)
cov2cor(v)
start5 <- c(alpha = .001,
beta = 10,
omega = 50,
death2 = .0000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
start5 <- c(alpha = .001,
beta = 8,
omega = 50,
death2 = .0000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
coef(chl_fit_108)
start5 <- c(alpha = .00001,
beta = 8,
omega = 50,
death2 = .0000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
start5 <- c(alpha = .0001,
beta = 8,
omega = 40,
death2 = .0000005,
pred_nh40 = 45,
pred_chl0 = 40,
gamma = 27)
chl_fit_108 <- fitode(
chl_nh4_mod,
data = dat_nit_108,
start=start5,
tcol = "date1",
solver.opts=list(method="rk4", hini=0.1))
plot(chl_fit_108,level = 0.95)
